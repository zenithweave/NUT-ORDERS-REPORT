<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Payment Report - Zenith Weave</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            padding: 24px 32px;
        }
        
        .header {
            background: #161b22;
            padding: 32px;
            border-radius: 6px;
            border: 1px solid #30363d;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 32px;
            color: #f0f6fc;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .header p {
            color: #8b949e;
            font-size: 16px;
            margin-bottom: 24px;
        }
        
        .branding {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: #0d1117;
            border-radius: 6px;
            border: 1px solid #21262d;
        }
        
        .branding-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .branding-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .branding-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .branding-info strong {
            color: #f0f6fc;
            font-size: 18px;
            font-weight: 600;
        }
        
        .branding-info span {
            color: #58a6ff;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .branding-right {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8b949e;
            font-size: 14px;
            padding: 8px 16px;
            background: #21262d;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        
        .branding-right::before {
            content: 'ðŸ“ž';
            font-size: 16px;
        }
        
        .filters {
            background: #161b22;
            padding: 24px;
            border-radius: 6px;
            border: 1px solid #30363d;
            margin-bottom: 24px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #f0f6fc;
            font-size: 14px;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            font-size: 14px;
            background: #0d1117;
            color: #c9d1d9;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #58a6ff;
            background: #161b22;
        }
        
        .filter-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #238636;
            color: white;
            border: 1px solid #2ea043;
        }
        
        .btn-primary:hover {
            background: #2ea043;
            border-color: #3fb950;
        }
        
        .btn-success {
            background: #1f6feb;
            color: white;
            border: 1px solid #388bfd;
        }
        
        .btn-success:hover {
            background: #388bfd;
            border-color: #58a6ff;
        }
        
        .btn-secondary {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }
        
        .btn-secondary:hover {
            background: #30363d;
            border-color: #8b949e;
        }
        
        .table-container {
            background: #161b22;
            border-radius: 6px;
            border: 1px solid #30363d;
            overflow: hidden;
        }
        
        .table-header {
            padding: 16px 24px;
            border-bottom: 1px solid #21262d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: #f0f6fc;
            font-size: 16px;
            font-weight: 600;
        }
        
        .order-count {
            color: #8b949e;
            font-size: 14px;
            background: #21262d;
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #0d1117;
        }
        
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #f0f6fc;
            font-size: 13px;
            border-bottom: 2px solid #21262d;
            white-space: nowrap;
        }
        
        td {
            padding: 12px 16px;
            border-bottom: 1px solid #21262d;
            font-size: 13px;
            color: #c9d1d9;
        }
        
        tbody tr:hover {
            background: #0d1117;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid;
        }
        
        .status-paid {
            background: rgba(46, 160, 67, 0.15);
            color: #3fb950;
            border-color: #2ea043;
        }
        
        .status-pending {
            background: rgba(187, 128, 9, 0.15);
            color: #d29922;
            border-color: #9e6a03;
        }
        
        .status-cod {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
            border-color: #1f6feb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6d7175;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #5c6ac4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: rgba(248, 81, 73, 0.15);
            border: 1px solid #f85149;
            color: #ff7b72;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6d7175;
        }
        
        .empty-state h3 {
            color: #202223;
            margin-bottom: 8px;
        }
        
        tbody tr {
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #161b22;
            margin: 5% auto;
            padding: 0;
            border-radius: 6px;
            border: 1px solid #30363d;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #21262d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: #f0f6fc;
            font-size: 20px;
            font-weight: 600;
        }
        
        .close {
            color: #8b949e;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #f0f6fc;
        }
        
        .modal-body {
            padding: 24px;
            background: #0d1117;
        }
        
        .detail-section {
            margin-bottom: 24px;
        }
        
        .detail-section h3 {
            color: #f0f6fc;
            font-size: 16px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #21262d;
            font-weight: 600;
        }
        
        .detail-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
        }
        
        .detail-label {
            font-weight: 600;
            color: #8b949e;
        }
        
        .detail-value {
            color: #c9d1d9;
        }
        
        .items-table {
            width: 100%;
            margin-top: 12px;
        }
        
        .items-table th {
            background: #161b22;
            padding: 8px;
            text-align: left;
            font-size: 12px;
            color: #f0f6fc;
            border-bottom: 1px solid #21262d;
        }
        
        .items-table td {
            padding: 8px;
            font-size: 13px;
            color: #c9d1d9;
            border-bottom: 1px solid #21262d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Order Payment Report</h1>
            <p>Comprehensive order report with payment method details and Stripe transaction information.</p>
            <div class="branding">
                <div class="branding-left">
                    <div class="branding-avatar">MM</div>
                    <div class="branding-info">
                        <strong>Mostafa Magdy</strong>
                        <span>ZENITH WEAVE AGENCY</span>
                    </div>
                </div>
                <div class="branding-right">
                    01011400020
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Order Number</label>
                    <input type="text" id="orderNumber" placeholder="Search by order number">
                </div>
                <div class="filter-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option value="">All Methods</option>
                        <option value="cod">Cash on Delivery</option>
                        <option value="kashier">Kashier</option>
                        <option value="manual">Manual Payment</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="dateTo">
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="loadOrders()">Apply Filters</button>
                <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
                <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
            </div>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        
        <div class="table-container">
            <div class="table-header">
                <h3>Orders</h3>
                <span class="order-count" id="orderCount">0 orders</span>
            </div>
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p>Loading order data...</p>
            </div>
            <div id="tableContent" style="display: none;">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Items</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="emptyState" class="empty-state" style="display: none;">
                <h3>No orders found</h3>
                <p>Try adjusting your filters or date range</p>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalOrderNumber">Order Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Order details will be inserted here -->
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = window.location.origin;
        let ordersData = [];
        
        // Set default dates (last 30 days)
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        document.getElementById('dateTo').value = today.toISOString().split('T')[0];
        document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function getPaymentMethodBadge(order) {
            const gateway = order.payment_gateway_names?.[0] || 'Unknown';
            if (gateway.toLowerCase().includes('cash')) {
                return '<span class="status-badge status-cod">Cash on Delivery</span>';
            } else if (gateway.toLowerCase().includes('kashier')) {
                return '<span class="status-badge status-paid">Kashier</span>';
            } else {
                return `<span class="status-badge status-pending">${gateway}</span>`;
            }
        }
        
        function getStatusBadge(status) {
            if (status === 'paid') {
                return '<span class="status-badge status-paid">Paid</span>';
            } else if (status === 'pending') {
                return '<span class="status-badge status-pending">Pending</span>';
            } else {
                return `<span class="status-badge">${status}</span>`;
            }
        }
        
        async function loadOrders() {
            const loadingEl = document.getElementById('loadingState');
            const tableEl = document.getElementById('tableContent');
            const emptyEl = document.getElementById('emptyState');
            
            loadingEl.style.display = 'block';
            tableEl.style.display = 'none';
            emptyEl.style.display = 'none';
            
            try {
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const orderNumber = document.getElementById('orderNumber').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                
                const params = new URLSearchParams({
                    created_at_min: dateFrom ? new Date(dateFrom).toISOString() : '',
                    created_at_max: dateTo ? new Date(dateTo + 'T23:59:59').toISOString() : '',
                    status: 'any'
                });
                
                const response = await fetch(`${API_BASE_URL}/api/orders?${params}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch orders');
                }
                
                const data = await response.json();
                ordersData = data.orders || [];
                
                // Filter by order number if specified
                if (orderNumber) {
                    ordersData = ordersData.filter(order => 
                        order.name.toLowerCase().includes(orderNumber.toLowerCase()) ||
                        order.order_number?.toString().includes(orderNumber)
                    );
                }
                
                // Filter by payment method if specified
                if (paymentMethod) {
                    ordersData = ordersData.filter(order => {
                        const gateway = order.payment_gateway_names?.[0] || '';
                        return gateway.toLowerCase().includes(paymentMethod);
                    });
                }
                
                displayOrders(ordersData);
                
            } catch (error) {
                console.error('Error loading orders:', error);
                showError('Error loading orders: ' + error.message);
                loadingEl.style.display = 'none';
                emptyEl.style.display = 'block';
            }
        }
        
        function showOrderDetails(order) {
            const modal = document.getElementById('orderModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalOrderNumber');
            
            modalTitle.textContent = `Order ${order.name}`;
            
            const customerName = [
                order.customer?.first_name || order.shipping_address?.first_name || '',
                order.customer?.last_name || order.shipping_address?.last_name || ''
            ].filter(Boolean).join(' ') || 'N/A';
            
            const shippingAddress = order.shipping_address ? [
                order.shipping_address.address1,
                order.shipping_address.address2,
                order.shipping_address.city,
                order.shipping_address.province,
                order.shipping_address.zip,
                order.shipping_address.country
            ].filter(Boolean).join(', ') : 'N/A';
            
            const billingAddress = order.billing_address ? [
                order.billing_address.address1,
                order.billing_address.address2,
                order.billing_address.city,
                order.billing_address.province,
                order.billing_address.zip,
                order.billing_address.country
            ].filter(Boolean).join(', ') : 'N/A';
            
            let itemsHTML = '<table class="items-table"><thead><tr><th>Product</th><th>SKU</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>';
            order.line_items?.forEach(item => {
                itemsHTML += `<tr>
                    <td>${item.name}</td>
                    <td>${item.sku || 'N/A'}</td>
                    <td>${item.quantity}</td>
                    <td>${order.currency} ${item.price}</td>
                    <td>${order.currency} ${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>
                </tr>`;
            });
            itemsHTML += '</tbody></table>';
            
            modalBody.innerHTML = `
                <div class="detail-section">
                    <h3>Order Information</h3>
                    <div class="detail-row"><div class="detail-label">Order Number:</div><div class="detail-value">${order.name}</div></div>
                    <div class="detail-row"><div class="detail-label">Order Date:</div><div class="detail-value">${formatDate(order.created_at)}</div></div>
                    <div class="detail-row"><div class="detail-label">Status:</div><div class="detail-value">${getStatusBadge(order.financial_status)}</div></div>
                    <div class="detail-row"><div class="detail-label">Payment Method:</div><div class="detail-value">${getPaymentMethodBadge(order)}</div></div>
                    <div class="detail-row"><div class="detail-label">Customer Note:</div><div class="detail-value">${order.note || 'N/A'}</div></div>
                </div>
                
                <div class="detail-section">
                    <h3>Customer Information</h3>
                    <div class="detail-row"><div class="detail-label">Name:</div><div class="detail-value">${customerName}</div></div>
                    <div class="detail-row"><div class="detail-label">Email:</div><div class="detail-value">${order.customer?.email || order.email || 'N/A'}</div></div>
                    <div class="detail-row"><div class="detail-label">Phone:</div><div class="detail-value">${order.customer?.phone || order.phone || 'N/A'}</div></div>
                </div>
                
                <div class="detail-section">
                    <h3>Shipping Address</h3>
                    <div class="detail-row"><div class="detail-label">Address:</div><div class="detail-value">${shippingAddress}</div></div>
                </div>
                
                <div class="detail-section">
                    <h3>Billing Address</h3>
                    <div class="detail-row"><div class="detail-label">Address:</div><div class="detail-value">${billingAddress}</div></div>
                </div>
                
                <div class="detail-section">
                    <h3>Order Items</h3>
                    ${itemsHTML}
                </div>
                
                <div class="detail-section">
                    <h3>Order Totals</h3>
                    <div class="detail-row"><div class="detail-label">Subtotal:</div><div class="detail-value">${order.currency} ${order.subtotal_price}</div></div>
                    <div class="detail-row"><div class="detail-label">Shipping:</div><div class="detail-value">${order.currency} ${order.total_shipping_price_set?.shop_money?.amount || order.total_shipping_price || '0.00'}</div></div>
                    <div class="detail-row"><div class="detail-label">Tax:</div><div class="detail-value">${order.currency} ${order.total_tax}</div></div>
                    <div class="detail-row"><div class="detail-label">Discounts:</div><div class="detail-value">${order.currency} ${order.total_discounts}</div></div>
                    <div class="detail-row"><div class="detail-label"><strong>Total:</strong></div><div class="detail-value"><strong>${order.currency} ${order.total_price}</strong></div></div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        function displayOrders(orders) {
            const tbody = document.getElementById('orderTableBody');
            const loadingEl = document.getElementById('loadingState');
            const tableEl = document.getElementById('tableContent');
            const emptyEl = document.getElementById('emptyState');
            const countEl = document.getElementById('orderCount');
            
            loadingEl.style.display = 'none';
            
            if (orders.length === 0) {
                emptyEl.style.display = 'block';
                tableEl.style.display = 'none';
                countEl.textContent = '0 orders';
                return;
            }
            
            tbody.innerHTML = '';
            
            orders.forEach(order => {
                const customerName = [
                    order.customer?.first_name || order.shipping_address?.first_name || '',
                    order.customer?.last_name || order.shipping_address?.last_name || ''
                ].filter(Boolean).join(' ') || 'N/A';
                
                const email = order.customer?.email || order.email || 'N/A';
                const phone = order.customer?.phone || order.phone || order.shipping_address?.phone || 'N/A';
                const itemCount = order.line_items?.length || 0;
                
                const row = document.createElement('tr');
                row.onclick = () => showOrderDetails(order);
                row.innerHTML = `
                    <td><strong>${order.name}</strong></td>
                    <td>${formatDate(order.created_at)}</td>
                    <td>${customerName}</td>
                    <td>${email}</td>
                    <td>${phone}</td>
                    <td>${getPaymentMethodBadge(order)}</td>
                    <td>${getStatusBadge(order.financial_status)}</td>
                    <td><strong>${order.currency} ${order.total_price}</strong></td>
                    <td>${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
                `;
                tbody.appendChild(row);
            });
            
            tableEl.style.display = 'block';
            countEl.textContent = `${orders.length} order${orders.length !== 1 ? 's' : ''}`;
        }
        
        async function exportToCSV() {
            if (ordersData.length === 0) {
                showError('No orders to export');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/export-orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        startDate: document.getElementById('dateFrom').value,
                        endDate: document.getElementById('dateTo').value,
                        status: 'any'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `orders_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                showError('Error exporting to CSV: ' + error.message);
            }
        }
        
        async function exportToExcel() {
            if (ordersData.length === 0) {
                showError('No orders to export');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/export-orders-excel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        startDate: document.getElementById('dateFrom').value,
                        endDate: document.getElementById('dateTo').value,
                        status: 'any'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Excel export failed');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `orders_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                showError('Error exporting to Excel: ' + error.message);
            }
        }
        
        // Load orders on page load
        loadOrders();
    </script>
</body>
</html>
